# Agile Two-Phase Workflow
# Phase 1: Collaborative Design (Client in control)
# Phase 2: Autonomous Execution (Agents in control)

workflow_name: "agile-two-phase"
version: "1.0"

# Documentation Configuration
documentation:
  mode: "comprehensive"

  templates:
    directory: "templates/comprehensive/"
    load_all: true

  session_context:
    format: "comprehensive"
    template: "templates/session-context/comprehensive.template.md"
    update_frequency: "action"
    max_words: unlimited

  directory_structure:
    create:
      - ".AutoSDLC/"
      - ".AutoSDLC/quality-reports/"
      - "docs/epics/"
      - "docs/stories/"
      - "docs/tasks/"
      - "architecture/decisions/"
      - "architecture/proposals/"

  quality_reports:
    type: "full"
    location: ".AutoSDLC/quality-reports/"

phases:
  design:
    name: "Collaborative Design"
    description: "Client makes all key decisions with agent support"
    autonomy_level: 40  # Agents propose, client decides

    active_agents:
      - project_manager
      - product_owner
      - solution_architect

    gates:
      gate_1:
        name: "PSA Approval"
        owner: "product_owner"
        deliverables:
          - "docs/PSA.md"
        approval_required: true
        client_action: "Review and approve PSA with all epics"

        jira_workflow_discovery:
          - "IF Atlassian MCP server is available:"
          - "  STEP 1: Get Project Information"
          - "    • PM asks user: 'What is your JIRA project key?' (e.g., PROJ, CAAD)"
          - "    • PM uses mcp_atlassian_atl_getVisibleJiraProjects to verify access"
          - "    • PM confirms project details with user"
          - ""
          - "  STEP 2: Learn Workflow via Test Items"
          - "    • PM creates test Epic: 'AutoSDLC Test Epic - Safe to Delete'"
          - "    • PM creates test Story under Epic: 'AutoSDLC Test Story - Safe to Delete'"
          - "    • PM creates test Sub-task under Story: 'AutoSDLC Test Subtask - Safe to Delete'"
          - "    • PM creates test Bug: 'AutoSDLC Test Bug - Safe to Delete'"
          - "    • PM creates test Task: 'AutoSDLC Test Task - Safe to Delete'"
          - "    • For each test item:"
          - "      - Use mcp_atlassian_atl_getTransitionsForJiraIssue to get available transitions"
          - "      - Document: status, available transitions, transition IDs, required fields"
          - "      - Try each transition to map workflow (or ask user permission)"
          - ""
          - "  STEP 3: Document Workflow"
          - "    • PM creates .AutoSDLC/memory/semantic/jira-workflow.md using jira-workflow.template.md"
          - "    • Include for each issue type:"
          - "      - Available statuses"
          - "      - Transition map (from → to, transition name, ID)"
          - "      - Custom fields (Story Points, Epic Link, etc.)"
          - "    • Document any multi-project configuration if applicable"
          - ""
          - "  STEP 4: Cleanup Test Items"
          - "    • PM asks user: 'Delete test items or keep marked as test?'"
          - "    • If delete: PM deletes test items"
          - "    • If keep: PM adds label 'autosdlc-test' and comment 'Safe to ignore'"
          - ""
          - "  STEP 5: Initialize Offline Queue"
          - "    • PM creates empty offline queue in jira-workflow.md"
          - "    • PM ready for JIRA coordination"
          - ""
          - "IF Atlassian MCP server NOT available:"
          - "  • PM notes in semantic memory: 'JIRA integration not available'"
          - "  • PM continues with file-based workflow only"

        success_criteria:
          - "All epics identified and described"
          - "High-level scope defined"
          - "Client approval received"
          - "IF MCP available: JIRA workflow learned and documented"

        on_approval:
          - "Trigger Gate 2 Stage 1: Epic creation process"
          - "Product Owner begins epic document creation"
          - "IF Atlassian MCP available: PM updates parent FEATURE status to 'In Progress'"

        memory_updates:
          semantic:
            - "MANDATORY: Update .AutoSDLC/memory/semantic/knowledge-base.md with:"
            - "  • Project scope and epic summaries from PSA"
            - "  • Key stakeholders and their roles"
            - "  • Project constraints and assumptions"
            - "MANDATORY: Create .AutoSDLC/memory/semantic/jira-workflow.md with:"
            - "  • Complete workflow mappings for all issue types"
            - "  • Multi-project configuration if applicable"
          episodic:
            - "MANDATORY: Update .AutoSDLC/memory/episodic/product-owner.md with:"
            - "  • PSA creation process and decisions made"
            - "  • Client feedback and concerns"
            - "  • Epic prioritization rationale"
            - "MANDATORY: Update .AutoSDLC/memory/episodic/pm.md with:"
            - "  • JIRA workflow discovery process"
            - "  • Test items created and deleted/marked"
            - "  • Any JIRA access issues encountered"
          procedural:
            - "Update .AutoSDLC/memory/procedural/user-preferences.yaml if:"
            - "  • Client expressed specific workflow preferences"
            - "  • Documentation format preferences noted"
          checkpoint:
            - "EXECUTE MEMORY CHECKPOINT after gate completion"
            - "Mark as: Checkpoint #{N} - Gate 1 PSA Complete"

        next_gate: "gate_2"

      gate_2:
        name: "Epics & Stories Approval"
        owner: "product_owner"
        deliverables:
          - "docs/epics/*.md"
          - "docs/stories/*.md"
          - "docs/gate2-summary.md"
        approval_required: true
        client_action: "Review and approve detailed user stories"

        process:
          stage_1_create_epics:
            - "Product Owner creates epic documents from PSA"
            - "IF Atlassian MCP server is available:"
            - "  • Present epic summaries to client for review"
            - "  • Show: Epic title, description, key features, dependencies and risks"
            - "  • Ask client: 'Review these epics. Approve to create in Jira, or suggest changes'"
            - "  • WAIT for client approval or changes"
            - "  • After approval: PM creates epics in Jira using learned workflow from jira-workflow.md"
            - "  • PM links epics to parent FEATURE using epic link field"
            - "  • PM updates epic documents with Jira epic keys and URLs"
            - "  • PM coordinates with Product Owner on completion"
            - "IF Atlassian MCP server NOT available:"
            - "  • Create epic markdown documents only"
            - "  • PM queues epic creation in jira-workflow.md offline_queue"
            - "  • Note in documents: 'Jira epic creation pending MCP availability'"

          stage_2_create_stories:
            - "Product Owner creates user story documents for each epic"
            - "Assign story points to each story"
            - "Document dependencies between stories"
            - "IF Atlassian MCP server is available:"
            - "  • Present story summaries to client for review"
            - "  • Show: Story title, epic, story points, acceptance criteria summary"
            - "  • Ask client: 'Review these stories. Approve to create in Jira, or suggest changes'"
            - "  • WAIT for client approval or changes"
            - "  • After approval: PM creates stories in Jira using learned workflow"
            - "  • PM assigns stories to their parent epics"
            - "  • PM sets Story Points field in Jira"
            - "  • PM links stories to epics and parent FEATURE"
            - "  • PM updates story documents with Jira issue keys and URLs"
            - "  • PM coordinates with Product Owner on completion"
            - "IF Atlassian MCP server NOT available:"
            - "  • Create story markdown documents only"
            - "  • PM queues story creation in jira-workflow.md offline_queue"
            - "  • Note in documents: 'Jira story creation pending MCP availability'"

          stage_3_create_summary:
            - "Create Gate 2 Summary document using gate2-summary.template.md"
            - "Include:"
            - "  • Complete epic hierarchy with Jira links (if available)"
            - "  • Story tables for each epic with points and Jira links"
            - "  • Story dependency maps"
            - "  • Scope summary with total story counts and points"
            - "  • Critical path and parallel workstreams"
            - "  • Next steps for Gate 3"
            - "Save as: docs/gate2-summary.md"

        jira_integration:
          coordination:
            - "PM coordinates all JIRA operations using learned workflow from jira-workflow.md"
            - "PM uses issue type mappings and transition IDs from Gate 1 workflow discovery"
            - "PM ensures proper status transitions and field updates"
          
          required_tools:
            - "mcp_atlassian_atl_createJiraIssue (for epics and stories)"
            - "mcp_atlassian_atl_getVisibleJiraProjects (to verify project access)"
            - "mcp_atlassian_atl_editJiraIssue (to set story points and epic links)"
            - "mcp_atlassian_atl_transitionJiraIssue (to update statuses)"
          
          epic_creation:
            - "Use issue type: 'Epic' (or custom type from jira-workflow.md)"
            - "Set summary from epic title"
            - "Set description from epic markdown content"
            - "Link to parent FEATURE using epic link field"
          
          story_creation:
            - "Use issue type: 'Story'"
            - "Set summary from story title"
            - "Set description from story markdown content"
            - "Set 'Story Points' field with estimated points"
            - "Link to parent epic using epic link field"
            - "Add labels if specified in story document"

        memory_updates:
          semantic:
            - "MANDATORY: Update .AutoSDLC/memory/semantic/knowledge-base.md with:"
            - "  • Epic and story structure"
            - "  • Story dependencies and relationships"
            - "  • Total scope (epic count, story count, story points)"
            - "  • Critical path and parallel workstreams"
            - "MANDATORY: Update .AutoSDLC/memory/semantic/jira-workflow.md with:"
            - "  • Epic/story creation operations completed"
            - "  • JIRA keys and links for all created items"
            - "  • Offline queue status (flush if MCP was available)"
          episodic:
            - "MANDATORY: Update .AutoSDLC/memory/episodic/product-owner.md with:"
            - "  • Epic and story creation decisions"
            - "  • Client feedback and changes requested"
            - "  • Scope adjustments made"
            - "MANDATORY: Update .AutoSDLC/memory/episodic/pm.md with:"
            - "  • JIRA operations performed (epics/stories created)"
            - "  • Any JIRA workflow issues or adjustments"
            - "  • Client approval timeline"
          procedural:
            - "Update .AutoSDLC/memory/procedural/user-preferences.yaml if:"
            - "  • Client expressed story format preferences"
            - "  • Specific JIRA field preferences noted"
          checkpoint:
            - "EXECUTE MEMORY CHECKPOINT after gate completion"
            - "Mark as: Checkpoint #{N} - Gate 2 Stories Complete"

        success_criteria:
          - "All user stories created with acceptance criteria"
          - "Story estimates provided"
          - "Dependencies identified"
          - "IF MCP available: All epics created in Jira with client approval"
          - "IF MCP available: All stories created in Jira under correct epics with story points"
          - "Gate 2 Summary document created with complete mapping"
          - "Client approval received"

        next_gate: "gate_3"

      gate_3:
        name: "Architecture Approval"
        owner: "solution_architect"
        deliverables:
          - "architecture/proposal.md"
          - "architecture/approved-architecture.md"
        approval_required: true
        client_action: "Choose from architecture options and approve final architecture"

        critical: true
        locks_after_approval:
          - "architecture/approved-architecture.md"
          - "architecture/tech-stack.yaml"

        architect_responsibilities:
          - "Present 2-3 options for each major technical decision"
          - "Provide pros/cons comparison matrix"
          - "Document client's chosen options"
          - "Create detailed architecture from client decisions"

        jira_integration:
          - "IF Atlassian MCP available:"
          - "  • PM adds architecture approval comment to parent FEATURE"
          - "  • Comment includes: link to approved-architecture.md, tech stack summary"
          - "  • PM coordinates with Solution Architect on JIRA updates"

        memory_updates:
          semantic:
            - "MANDATORY: Update .AutoSDLC/memory/semantic/knowledge-base.md with:"
            - "  • Approved architecture details"
            - "  • Technology stack decisions (locked)"
            - "  • Client's chosen options from proposal"
            - "  • Architecture constraints and assumptions"
          episodic:
            - "MANDATORY: Update .AutoSDLC/memory/episodic/solution-architect.md with:"
            - "  • Architecture options presented"
            - "  • Client decision-making process"
            - "  • Rationale for recommended options"
            - "MANDATORY: Update .AutoSDLC/memory/episodic/pm.md with:"
            - "  • JIRA comment added to FEATURE"
            - "  • Architecture approval milestone"
          procedural:
            - "Update .AutoSDLC/memory/procedural/user-preferences.yaml if:"
            - "  • Client expressed architecture documentation preferences"
            - "  • Specific tech stack preferences for future projects"
          checkpoint:
            - "EXECUTE MEMORY CHECKPOINT after gate completion"
            - "Mark as: Checkpoint #{N} - Gate 3 Architecture Locked"

        success_criteria:
          - "All technical options presented (backend, frontend, database, etc.)"
          - "Client makes all technical decisions"
          - "Architecture fully documented"
          - "Tech stack locked"
          - "Client says 'Architecture approved'"
          - "IF MCP available: Architecture approval recorded in JIRA FEATURE"

        next_gate: "gate_4"

      gate_4:
        name: "Sprint Planning"
        owner: "project_manager"
        deliverables:
          - "status/sprint-plan.md"
          - "docs/tasks/*.md"
        approval_required: true
        client_action: "Review and approve sprint plan and task assignments"

        pm_responsibilities:
          - "Break stories into technical tasks"
          - "Assign tasks to specialized agents"
          - "Create sprint timeline with milestones"
          - "Coordinate with all agents on capacity and dependencies"

        jira_integration:
          - "IF Atlassian MCP available:"
          - "  • PM creates Sub-tasks in JIRA for each technical task"
          - "  • PM assigns Sub-tasks to agents (using agent role as assignee indicator)"
          - "  • PM links Sub-tasks to parent Stories"
          - "  • PM adds sprint information to Stories and Sub-tasks"
          - "  • PM transitions Stories from 'Backlog' to 'Ready for Development' (using learned workflow)"
          - "IF MCP NOT available:"
          - "  • PM queues Sub-task creation in jira-workflow.md offline_queue"

        memory_updates:
          semantic:
            - "MANDATORY: Update .AutoSDLC/memory/semantic/knowledge-base.md with:"
            - "  • Sprint plan structure and timeline"
            - "  • Task-to-agent assignments"
            - "  • Critical path and dependencies"
            - "  • Sprint milestones and deliverables"
            - "MANDATORY: Update .AutoSDLC/memory/semantic/jira-workflow.md with:"
            - "  • Sub-tasks created in JIRA"
            - "  • Sprint field values used"
            - "  • Story status transitions performed"
          episodic:
            - "MANDATORY: Update .AutoSDLC/memory/episodic/pm.md with:"
            - "  • Sprint planning decisions"
            - "  • Task breakdown rationale"
            - "  • Agent assignment strategy"
            - "  • Client feedback on sprint plan"
            - "  • JIRA operations performed"
          procedural:
            - "Update .AutoSDLC/memory/procedural/user-preferences.yaml if:"
            - "  • Client expressed sprint length preferences"
            - "  • Specific task breakdown preferences noted"
          checkpoint:
            - "EXECUTE MEMORY CHECKPOINT after gate completion"
            - "Mark as: Checkpoint #{N} - Gate 4 Sprint Planned"

        success_criteria:
          - "Stories broken down into tasks"
          - "Tasks assigned to agents"
          - "Sprint timeline defined"
          - "IF MCP available: All Sub-tasks created in JIRA"
          - "IF MCP available: Stories transitioned to 'Ready for Development'"
          - "Client approval received"

        next_phase: "execution"

    phase_completion:
      trigger: "Client says 'Begin Execution' or 'Architecture approved, begin execution'"
      validation:
        - "All 4 gates completed"
        - "Architecture locked"
        - "Sprint plan approved"

  execution:
    name: "Autonomous Execution"
    description: "Agents build autonomously per approved architecture"
    autonomy_level: 90  # Agents decide implementation details

    active_agents:
      - project_manager
      - product_owner
      - solution_architect
      - backend_developer
      - frontend_developer
      - ml_engineer
      - devops_engineer
      - qa_automation
      - qa_manual

    locked_documents:
      - "architecture/approved-architecture.md"
      - "architecture/tech-stack.yaml"

    gates:
      gate_5:
        name: "Sprint Review"
        owner: "project_manager"
        recurring: true
        frequency: "end_of_sprint"
        deliverables:
          - "Completed tasks demo"
          - "Sprint retrospective"
          - "Next sprint plan"
        approval_required: false
        client_action: "Review completed work and provide feedback"

        pm_responsibilities:
          - "Collect completion status from all agents"
          - "Update JIRA items based on task completion"
          - "Coordinate sprint retrospective"
          - "Plan next sprint based on remaining work"

        jira_integration:
          - "IF Atlassian MCP available:"
          - "  • PM reviews all Sub-tasks assigned in this sprint"
          - "  • For completed Sub-tasks:"
          - "    - PM transitions to 'Done' using learned workflow"
          - "  • For in-progress Sub-tasks:"
          - "    - PM transitions to appropriate status"
          - "    - PM adds comment with progress notes"
          - "  • When all Sub-tasks for a Story are Done:"
          - "    - PM transitions parent Story to 'Done'"
          - "  • When all Stories for an Epic are Done:"
          - "    - PM transitions parent Epic to 'Done'"
          - "  • PM updates parent FEATURE with sprint completion comment"
          - "IF MCP NOT available:"
          - "  • PM queues all transitions in jira-workflow.md offline_queue"

        memory_updates:
          semantic:
            - "MANDATORY: Update .AutoSDLC/memory/semantic/knowledge-base.md with:"
            - "  • Sprint completion status"
            - "  • Completed vs remaining work"
            - "  • Major accomplishments and blockers"
            - "MANDATORY: Update .AutoSDLC/memory/semantic/jira-workflow.md with:"
            - "  • All JIRA transitions performed"
            - "  • Current status of all epics/stories/subtasks"
          episodic:
            - "MANDATORY: Update .AutoSDLC/memory/episodic/pm.md with:"
            - "  • Sprint review outcomes"
            - "  • Client feedback received"
            - "  • Next sprint planning decisions"
            - "  • JIRA status updates performed"
            - "ALL AGENTS: Update respective episodic memories with:"
            - "  • Tasks completed this sprint"
            - "  • Challenges encountered and solutions"
            - "  • Learnings for next sprint"
          procedural:
            - "Update .AutoSDLC/memory/procedural/user-preferences.yaml if:"
            - "  • Client expressed new preferences during review"
            - "  • Feedback patterns suggest process adjustments"
          checkpoint:
            - "EXECUTE MEMORY CHECKPOINT after sprint review"
            - "Mark as: Checkpoint #{N} - Sprint {X} Complete"

        success_criteria:
          - "Sprint goals achieved or variance explained"
          - "Completed work demonstrated"
          - "IF MCP available: All completed JIRA items transitioned to Done"
          - "IF MCP available: All in-progress items have updated status"
          - "Next sprint planned"

        next_gate: "gate_5"  # Repeats

    escalation_triggers:
      - condition: "Architecture change required"
        action: "Escalate to client for approval"
        blocks_execution: true

      - condition: "Critical blocker encountered"
        action: "Escalate to client immediately"
        blocks_execution: true

      - condition: "External dependency issue"
        action: "Notify client, PM finds workaround"
        blocks_execution: false

    phase_completion:
      trigger: "All epics marked complete"
      validation:
        - "All stories completed"
        - "All tests passing"
        - "Documentation updated"
        - "Client final approval"

# Transition Rules
transitions:
  design_to_execution:
    required_approvals:
      - gate_1
      - gate_2
      - gate_3
      - gate_4

    client_command: "Begin Execution"

    changes_on_transition:
      - "Activate all 9 agents"
      - "Lock architecture documents"
      - "Set autonomy_level to 90"
      - "PM takes coordination role"

  execution_to_design:
    trigger: "Architecture change required and client approves return to design"

    changes_on_transition:
      - "Pause execution agents"
      - "Unlock architecture if approved"
      - "Re-run Gate 3 with new options"
      - "Client re-approves architecture"

# Agent Responsibilities by Phase
agent_behaviors:
  design_phase:
    project_manager:
      - "Present gates to client"
      - "Coordinate PO and Architect"
      - "Ensure client understands options"

    product_owner:
      - "Create PSA"
      - "Create epics and stories"
      - "Define acceptance criteria"
      - "Present to client for approval"

    solution_architect:
      - "Research technical options"
      - "Present 2-3 options for each decision"
      - "Provide pros/cons comparisons"
      - "NEVER make final technical decisions"
      - "Document client's choices"
      - "Create detailed architecture"

    developers:
      - "Silent, waiting"
      - "May be consulted by architect for feasibility"

  execution_phase:
    project_manager:
      - "Coordinate all agents"
      - "Track sprint progress"
      - "Run sprint reviews"
      - "Escalate blockers"

    product_owner:
      - "Refine stories autonomously"
      - "Clarify requirements for dev team"
      - "Validate completed work"

    solution_architect:
      - "Enforce approved architecture"
      - "Review code for architecture compliance"
      - "Make minor technical decisions (document as ADRs)"
      - "Escalate if architecture change needed"

    developers:
      - "Implement features autonomously"
      - "Follow approved architecture"
      - "Collaborate via PM coordination"
      - "Write tests"
      - "Create PRs"

    devops:
      - "Set up CI/CD per architecture"
      - "Manage deployments"
      - "Monitor infrastructure"

    qa:
      - "Write automated tests"
      - "Perform manual testing"
      - "Validate acceptance criteria"
      - "Report bugs"
      - "Review ALL stories before completion (mandatory peer review)"
      - "Verify no stub implementations exist"
      - "Run tests to confirm they pass"
      - "Reject stories that don't meet Definition of Done"

# Story Completion Workflow
story_lifecycle:
  states:
    - todo
    - in_progress
    - code_review      # NEW: Mandatory review state
    - testing          # NEW: QA verification state
    - done

  transitions:
    to_in_progress:
      from: "todo"
      trigger: "Developer agent starts work"
      required: "PM assigns story to agent"

    to_code_review:
      from: "in_progress"
      trigger: "Developer claims work is complete"
      required:
        - "Code committed"
        - "Tests written"
        - "Build passes"
      action: "PM assigns different agent as reviewer"

    to_testing:
      from: "code_review"
      trigger: "Code reviewer approves implementation"
      required:
        - "Reviewer verified code exists (no stubs)"
        - "Reviewer ran tests and confirmed passing"
        - "Review checklist completed"
        - "Review documented"
      action: "PM assigns QA agent for final verification"

    to_done:
      from: "testing"
      trigger: "QA verifies all acceptance criteria met"
      required:
        - "QA ran all tests and confirmed passing"
        - "QA verified feature works manually"
        - "All Definition of Done items checked"
        - "PM spot-checked actual code"
        - "No stubs/placeholders remain"
      action: "PM updates status.yaml with completion"
      verification: "PM must read code and run tests before marking done"

  rejection_paths:
    code_review_rejects:
      from: "code_review"
      to: "in_progress"
      reason: "Stubs found, tests failing, or criteria not met"
      action: "Developer fixes issues and re-submits"

    testing_rejects:
      from: "testing"
      to: "in_progress"
      reason: "Tests failing or feature doesn't work"
      action: "Developer fixes issues, goes through review again"

# Quality Gates for Story Completion
story_completion_gates:
  gate_review:
    name: "Peer Code Review"
    owner: "Assigned reviewer (different agent)"
    mandatory: true
    checklist:
      - "Read actual code files (not just status)"
      - "Verify no stub implementations (no 'not yet implemented')"
      - "Run tests and confirm they pass"
      - "Check all acceptance criteria are met"
      - "Verify code compiles and builds"
    deliverable: "Review report documenting verification"

  gate_qa:
    name: "QA Verification"
    owner: "qa_automation OR qa_manual"
    mandatory: true
    checklist:
      - "Run all tests for this story"
      - "Manually test the feature"
      - "Verify Definition of Done is met"
      - "Check no regression in other features"
    deliverable: "QA sign-off report"

  gate_pm_verification:
    name: "PM Final Verification"
    owner: "project_manager"
    mandatory: true
    checklist:
      - "Read review report from reviewer"
      - "Read QA report"
      - "Spot-check code files"
      - "Run build and tests"
      - "Verify status matches reality"
    deliverable: "Status update in status.yaml"
